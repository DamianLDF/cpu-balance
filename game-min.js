var sequence1,sequence2,sequence3,ac=new AudioContext,when=ac.currentTime,tempo=132,lead=["-   e","Bb3 e","A3  e","Bb3 e","G3  e","A3  e","F3  e","G3  e","E3  e","F3  e","G3  e","F3  e","E3  e","F3  e","D3  q","-   e","Bb3 s","A3  s","Bb3 e","G3  e","A3  e","G3  e","F3  e","G3  e","E3  e","F3  e","G3  e","F3  e","E3  s","F3  s","E3  e","D3  q"],harmony=["-   e","D4  e","C4  e","D4  e","Bb3 e","C4  e","A3  e","Bb3 e","G3  e","A3  e","Bb3 e","A3  e","G3  e","A3  e","F3  q","-   e","D4  s","C4  s","D4  e","Bb3 e","C4  e","Bb3 e","A3  e","Bb3 e","G3  e","A3  e","Bb3 e","A3  e","G3  s","A3  s","G3  e","F3  q"],bass=["D3  q","-   h","D3  q","A2  q","-   h","A2  q","Bb2 q","-   h","Bb2 q","F2  h","A2  h"];let ctx,fl,cp,pl,lx,ly,l1=["00000","00P00","00000","010A0","00000"],l2=["00000","002A0","0P000","001B0","00000"],l3=["00P00","01010","00000","00B00","00000"],l4=["00P00","0-1-0","0-B-0","00100","00000"],kb={},msg={};function key_down(e){switch_key(e,!0)}function key_up(e){switch_key(e,!1)}function switch_key(e,t){switch(e.which){case 87:case 38:e.preventDefault(),kb.u=t;break;case 68:case 39:e.preventDefault(),kb.r=t;break;case 83:case 40:e.preventDefault(),kb.d=t;break;case 65:case 37:e.preventDefault(),kb.l=t;break}}function page_load(){let e=document.getElementById("cnv");ctx=e.getContext("2d");setInterval(process,100);load_level(l1),sequence1=new TinyMusic.Sequence(ac,tempo,lead),sequence2=new TinyMusic.Sequence(ac,tempo,harmony),sequence3=new TinyMusic.Sequence(ac,tempo,bass),sequence1.staccato=.55,sequence2.staccato=.55,sequence3.staccato=.05,sequence3.smoothing=.4,sequence1.gain.gain.value=.25,sequence2.gain.gain.value=.2,sequence3.gain.gain.value=.1875,sequence1.mid.frequency.value=800,sequence1.mid.gain.value=-10,sequence2.mid.frequency.value=1200,sequence3.mid.gain.value=-10,sequence3.bass.gain.value=-7,sequence3.bass.frequency.value=80,sequence3.mid.gain.value=-16,sequence3.mid.frequency.value=500,sequence3.treble.gain.value=-12,sequence3.treble.frequency.value=1400,sequence1.play(when),sequence2.play(when+60/tempo*16),sequence3.play(when)}function process(e){ctx.fillStyle="#EEEEEE",ctx.fillRect(0,0,800,600),msg.show||pl.s;let t=600/(32*lx),c=600/(32*ly),l=t<c?t:c;for(let e=0;e<lx;e++)for(let t=0;t<ly;t++){let c=get_floor(e,t);"-"===c&&draw_wall(32*e*l,32*t*l,l),"0"===c&&draw_floor(32*e*l,32*t*l,l),"A"===c&&draw_socket(32*e*l,32*t*l,l),"B"===c&&draw_socket(32*e*l,32*t*l,l)}draw_player_idle(32*pl.x*l,32*pl.y*l,l,pl.d)}function load_level(e){lx=0,ly=0,fl={},cp=[],pl={};for(let t=0;t<e.length;t++)for(let c=0;c<e[t].length;c++)["0","A","B","C","D","E","F","G","H","I","J"].includes(e[t][c])?add_floor(c+1,t+1,e[t][c]):["1","2","3","4","5","6","7","8","9","X"].includes(e[t][c])?(add_floor(c+1,t+1,"0"),cp.push({x:c+1,y:t+1,t:e[t][c]})):"P"===e[t][c]&&(pl.x=c+1,pl.y=t+1,pl.d=0,add_floor(c+1,t+1,"0"))}function add_floor(e,t,c){fl[e]||(fl[e]={}),fl[e][t]=c,e+2>lx&&(lx=e+2),t+2>ly&&(ly=t+2)}function get_floor(e,t){return fl[e]&&fl[e][t]?fl[e][t]:"-"}function draw_floor(e,t,c){ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#111111",fill_tile(e,t,c),ctx.stroke()}function draw_wall(e,t,c){ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#111111",fill_tile(e,t,c);for(let l=1;l<=3;l++)ctx.stroke(),ctx.beginPath(),ctx.moveTo(e,t+8*l*c),ctx.lineTo(e+32*c,t+8*l*c),ctx.stroke();for(let l=0;l<2;l++)ctx.beginPath(),ctx.moveTo(e+11*c,t+16*c*l),ctx.lineTo(e+11*c,t+8*c+16*c*l),ctx.stroke(),ctx.beginPath(),ctx.moveTo(e+22*c,t+8*c+16*c*l),ctx.lineTo(e+22*c,t+16*c+16*c*l),ctx.stroke()}function draw_chip(e,t,c){ctx.fillStyle="#222222",ctx.strokeStyle="#222222",draw_chip_shape(e,t,c)}function draw_socket(e,t,c){ctx.fillStyle="#444444",ctx.strokeStyle="#111111",ctx.beginPath(),fill_tile(e,t,c),ctx.stroke(),ctx.fillStyle="#FFFFFF",draw_chip_shape(e,t,c)}function fill_tile(e,t,c){c||(c=1),ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(e+32*c,t),ctx.lineTo(e+32*c,t+32*c),ctx.lineTo(e,t+32*c),ctx.lineTo(e,t),ctx.fill()}function draw_chip_shape(e,t,c){c||(c=1),ctx.beginPath(),ctx.moveTo(e+5*c,t+5*c),ctx.lineTo(e+27*c,t+5*c),ctx.lineTo(e+27*c,t+27*c),ctx.lineTo(e+5*c,t+27*c),ctx.fill();for(let l=0;l<7;l++)ctx.beginPath(),ctx.moveTo(e+6*c+3*l*c,t+30*c),ctx.lineTo(e+6*c+3*l*c,t+2*c),ctx.lineTo(e+7*c+3*l*c,t+2*c),ctx.lineTo(e+7*c+3*l*c,t+30*c),ctx.fill(),ctx.beginPath(),ctx.moveTo(e+30*c,t+6*c+3*l*c),ctx.lineTo(e+2*c,t+6*c+3*l*c),ctx.lineTo(e+2*c,t+7*c+3*l*c),ctx.lineTo(e+30*c,t+7*c+3*l*c),ctx.fill()}function draw_player_idle(e,t,c,l){c||(c=1);let o=e+16*c,i=t+16*c;if(0==l||2==l)ctx.fillStyle="#FFFFFF",ctx.beginPath(),ctx.moveTo(o-9*c,i-2*c),ctx.quadraticCurveTo(o-14*c,i,o-14*c,i+8*c),ctx.quadraticCurveTo(o-12*c,i+10*c,o-10*c,i+8*c),ctx.lineTo(o-10*c,i+4*c),ctx.lineTo(o-9*c,i+7*c),ctx.lineTo(o+9*c,i+7*c),ctx.lineTo(o+10*c,i+4*c),ctx.lineTo(o+10*c,i+8*c),ctx.quadraticCurveTo(o+12*c,i+10*c,o+14*c,i+8*c),ctx.quadraticCurveTo(o+14*c,i,o+9*c,i-2*c),ctx.stroke(),ctx.fill(),ctx.beginPath(),ctx.moveTo(o-9*c,i-2*c),ctx.quadraticCurveTo(o-14*c,i-8*c,o-7*c,i-14*c),ctx.quadraticCurveTo(o,i-16*c,o+7*c,i-14*c),ctx.quadraticCurveTo(o+14*c,i-8*c,o+9*c,i-2*c),ctx.quadraticCurveTo(o,i,o-9*c,i-2*c),ctx.stroke(),0==l?(ctx.fill(),ctx.fillStyle="#000000"):(ctx.fillStyle="#000000",ctx.fill()),ctx.beginPath(),ctx.moveTo(o-9*c,i+7*c),ctx.lineTo(o-7*c,i+14*c),ctx.quadraticCurveTo(o-5*c,i+16*c,o-3*c,i+14*c),ctx.lineTo(o,i+10*c),ctx.lineTo(o+3*c,i+14*c),ctx.quadraticCurveTo(o+5*c,i+16*c,o+7*c,i+14*c),ctx.lineTo(o+9*c,i+7*c),ctx.lineTo(o-9*c,i+7*c),ctx.stroke(),ctx.fill(),0==l&&(ctx.beginPath(),ctx.moveTo(o-7*c,i-14*c),ctx.quadraticCurveTo(o,i-16*c,o+7*c,i-14*c),ctx.quadraticCurveTo(o,i-11*c,o-7*c,i-14*c),ctx.fill(),ctx.beginPath(),ctx.arc(o-6*c,i-8*c,2*c,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(o+6*c,i-8*c,2*c,0,2*Math.PI),ctx.fill());else{let e=1==l?1:-1;ctx.fillStyle="#FFFFFF",ctx.beginPath(),ctx.moveTo(o-7*c,i-2*c),ctx.lineTo(o-5*c,i+7*c),ctx.lineTo(o+5*c,i+7*c),ctx.lineTo(o+7*c,i-2*c),ctx.stroke(),ctx.fill(),ctx.beginPath(),ctx.moveTo(o-7*c,i-2*c),ctx.quadraticCurveTo(o-10*c,i-8*c,o-7*c,i-14*c),ctx.quadraticCurveTo(o,i-16*c,o+7*c,i-14*c),ctx.quadraticCurveTo(o+10*c,i-8*c,o+7*c,i-2*c),ctx.quadraticCurveTo(o,i,o-7*c,i-2*c),ctx.stroke(),ctx.fill(),ctx.fillStyle="#000000",ctx.beginPath(),ctx.moveTo(o-7*c*e,i-2*c),ctx.quadraticCurveTo(o-10*c*e,i-8*c,o-7*c*e,i-14*c),ctx.quadraticCurveTo(o,i-16*c,o+7*c*e,i-14*c),ctx.quadraticCurveTo(o+1*c*e,i-10*c,o-5*c*e,i-12*c),ctx.quadraticCurveTo(o-5*c*e,i-5*c,o-7*c*e,i-2*c),ctx.stroke(),ctx.fill(),ctx.beginPath(),ctx.arc(o+4*c*e,i-8*c,2*c,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.moveTo(o-5*c,i+7*c),ctx.lineTo(o-2*c,i+14*c),ctx.quadraticCurveTo(o,i+16*c,o+2*c,i+14*c),ctx.lineTo(o+5*c,i+7*c),ctx.stroke(),ctx.fill(),ctx.fillStyle="#FFFFFF",ctx.beginPath(),ctx.moveTo(o-2*c,i+4*c),ctx.lineTo(o-2*c,i+8*c),ctx.quadraticCurveTo(o,i+10*c,o+2*c,i+8*c),ctx.lineTo(o+2*c,i+4*c),ctx.stroke(),ctx.fill()}}window.addEventListener("load",page_load,!1);