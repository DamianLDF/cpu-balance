var sequence1,sequence2,sequence3,ac=new AudioContext,when=ac.currentTime,tempo=132,lead=["-   e","Bb3 e","A3  e","Bb3 e","G3  e","A3  e","F3  e","G3  e","E3  e","F3  e","G3  e","F3  e","E3  e","F3  e","D3  q","-   e","Bb3 s","A3  s","Bb3 e","G3  e","A3  e","G3  e","F3  e","G3  e","E3  e","F3  e","G3  e","F3  e","E3  s","F3  s","E3  e","D3  q"],harmony=["-   e","D4  e","C4  e","D4  e","Bb3 e","C4  e","A3  e","Bb3 e","G3  e","A3  e","Bb3 e","A3  e","G3  e","A3  e","F3  q","-   e","D4  s","C4  s","D4  e","Bb3 e","C4  e","Bb3 e","A3  e","Bb3 e","G3  e","A3  e","Bb3 e","A3  e","G3  s","A3  s","G3  e","F3  q"],bass=["D3  q","-   h","D3  q","A2  q","-   h","A2  q","Bb2 q","-   h","Bb2 q","F2  h","A2  h"];const FPS=30;let ctx,fl,cp,pl,l1=["00000","00P00","00000","010A0","00000"],l2=["00000","002A0","0P000","001B0","00000"],l3=["00P00","01010","00000","00B00","00000"],l4=["0P000","00000","0-1-0","0-K-0","00000"],test_lvl=["P00000000000","0123456789X0","000000000000","0123456789X0","0000---00000","0ABCDEFGHIJ0","000000000000"],cpu_merge={1:"2",2:"3",3:"4",4:"5",5:"6",6:"7",7:"8",8:"9",9:"X",X:"X"},cpu_nrg={1:["A","B","C","D","E","F","G","H","I","J"],2:["B","C","D","E","F","G","H","I","J"],3:["C","D","E","F","G","H","I","J"],4:["D","E","F","G","H","I","J"],5:["E","F","G","H","I","J"],6:["F","G","H","I","J"],7:["G","H","I","J"],8:["H","I","J"],9:["I","J"],X:["J"]},kb={},msg={},lvl={};function key_down(l){switch_key(l,!0)}function key_up(l){switch_key(l,!1)}function switch_key(l,e){switch(l.which){case 87:case 38:l.preventDefault(),kb.u=e;break;case 68:case 39:l.preventDefault(),kb.r=e;break;case 83:case 40:l.preventDefault(),kb.d=e;break;case 65:case 37:l.preventDefault(),kb.l=e;break;case 82:case 8:l.preventDefault(),kb.rst=e;break}}function page_load(){let l=document.getElementById("cnv");ctx=l.getContext("2d"),document.addEventListener("keydown",key_down,!1),document.addEventListener("keyup",key_up,!1);setInterval(process,1e3/30);load_level(test_lvl),sequence1=new TinyMusic.Sequence(ac,tempo,lead),sequence2=new TinyMusic.Sequence(ac,tempo,harmony),sequence3=new TinyMusic.Sequence(ac,tempo,bass),sequence1.staccato=.55,sequence2.staccato=.55,sequence3.staccato=.05,sequence3.smoothing=.4,sequence1.gain.gain.value=.25,sequence2.gain.gain.value=.2,sequence3.gain.gain.value=.1875,sequence1.mid.frequency.value=800,sequence1.mid.gain.value=-10,sequence2.mid.frequency.value=1200,sequence3.mid.gain.value=-10,sequence3.bass.gain.value=-7,sequence3.bass.frequency.value=80,sequence3.mid.gain.value=-16,sequence3.mid.frequency.value=500,sequence3.treble.gain.value=-12,sequence3.treble.frequency.value=1400,sequence1.play(when),sequence2.play(when+60/tempo*16),sequence3.play(when)}function process(){if(ctx.fillStyle="#EEEEEE",ctx.fillRect(0,0,800,600),msg.show);else if(kb.rst)reload_level();else if(0===pl.s)kb.u?(pl.d=0,can_walk()&&(pl.s=1,pl.t=32,pl.o=get_obj_pushed())):kb.d?(pl.d=2,can_walk()&&(pl.s=1,pl.t=32,pl.o=get_obj_pushed())):kb.l?(pl.d=3,can_walk()&&(pl.s=1,pl.t=32,pl.o=get_obj_pushed())):kb.r&&(pl.d=1,can_walk()&&(pl.s=1,pl.t=32,pl.o=get_obj_pushed()));else if(1===pl.s){let l=3.2;if(pl.t-=l,pl.t>0){0===pl.d&&(pl.dy-=l),1===pl.d&&(pl.dx+=l),2===pl.d&&(pl.dy+=l),3===pl.d&&(pl.dx-=l);for(let e=0;e<pl.o.length;e++)0===pl.d&&(pl.o[e].dy-=l),1===pl.d&&(pl.o[e].dx+=l),2===pl.d&&(pl.o[e].dy+=l),3===pl.d&&(pl.o[e].dx-=l)}else{pl.dx=0,pl.dy=0,0===pl.d&&(pl.y-=1),1===pl.d&&(pl.x+=1),2===pl.d&&(pl.y+=1),3===pl.d&&(pl.x-=1);for(let l=0;l<pl.o.length-1;l++)0===pl.d&&(pl.o[l].y-=1),1===pl.d&&(pl.o[l].x+=1),2===pl.d&&(pl.o[l].y+=1),3===pl.d&&(pl.o[l].x-=1),pl.o[l].dx=0,pl.o[l].dy=0;if(pl.o.length>0){let l=pl.o[pl.o.length-1],e=l.x,t=l.y;0===pl.d&&(t-=1),1===pl.d&&(e+=1),2===pl.d&&(t+=1),3===pl.d&&(e-=1);let c=get_item(e,t);null!==c&&cpu_merge[c.t]?(c.t=cpu_merge[c.t],l.x=-1):(l.x=e,l.y=t),l.dx=0,l.dy=0}pl.s=0}}let l=800/(32*lvl.x),e=600/(32*lvl.y),t=l<e?l:e;for(let l=0;l<lvl.x;l++)for(let e=0;e<lvl.y;e++){let c=get_floor(l,e);"-"===c&&draw_wall(32*l*t,32*e*t,t),"0"===c&&draw_floor(32*l*t,32*e*t,t),["A","B","C","D","E","F","G","H","I","J"].includes(c)&&draw_socket(32*l*t,32*e*t,t,c)}for(let l=0;l<cp.length;l++)draw_chip(32*cp[l].x*t+cp[l].dx*t,32*cp[l].y*t+cp[l].dy*t,t,cp[l].t,get_chip_nrg(cp[l]));draw_player_idle(32*pl.x*t+pl.dx*t,32*pl.y*t+pl.dy*t,t,pl.d)}function reload_level(){load_level(lvl.l)}function load_level(l){lvl.x=0,lvl.y=0,lvl.l=l,fl={},cp=[],pl={};for(let e=0;e<l.length;e++)for(let t=0;t<l[e].length;t++)["0","A","B","C","D","E","F","G","H","I","J"].includes(l[e][t])?add_floor(t+1,e+1,l[e][t]):["1","2","3","4","5","6","7","8","9","X"].includes(l[e][t])?(add_floor(t+1,e+1,"0"),cp.push({x:t+1,y:e+1,dx:0,dy:0,t:l[e][t]})):"K"===l[e][t]?(add_floor(t+1,e+1,"B"),cp.push({x:t+1,y:e+1,dx:0,dy:0,t:"1"})):"P"===l[e][t]&&(pl.x=t+1,pl.y=e+1,pl.d=2,pl.dx=0,pl.dy=0,pl.s=0,add_floor(t+1,e+1,"0"))}function add_floor(l,e,t){fl[l]||(fl[l]={}),fl[l][e]=t,l+2>lvl.x&&(lvl.x=l+2),e+2>lvl.y&&(lvl.y=e+2)}function get_floor(l,e){return fl[l]&&fl[l][e]?fl[l][e]:"-"}function get_item(l,e){for(let t=0;t<cp.length;t++)if(cp[t].x===l&&cp[t].y===e)return cp[t];return null}function can_walk(){let l=!1,e=!0,t=1,c=null;for(;e;){let p;if(0===pl.d?p=get_floor(pl.x,pl.y-t):1===pl.d?p=get_floor(pl.x+t,pl.y):2===pl.d?p=get_floor(pl.x,pl.y+t):3===pl.d&&(p=get_floor(pl.x-t,pl.y)),"-"===p)l=!1,e=!1;else{let o;0===pl.d?o=get_item(pl.x,pl.y-t):1===pl.d?o=get_item(pl.x+t,pl.y):2===pl.d?o=get_item(pl.x,pl.y+t):3===pl.d&&(o=get_item(pl.x-t,pl.y)),o?(o.t===c&&"0"===p&&(l=!0,e=!1),c=o.t):(l=!0,e=!1)}t++}return l}function get_obj_pushed(){let l=[],e=!0,t=1,c=null;for(;e;){let p;if(0===pl.d?p=get_floor(pl.x,pl.y-t):1===pl.d?p=get_floor(pl.x+t,pl.y):2===pl.d?p=get_floor(pl.x,pl.y+t):3===pl.d&&(p=get_floor(pl.x-t,pl.y)),"-"===p)e=!1,l=[];else{let o;0===pl.d?o=get_item(pl.x,pl.y-t):1===pl.d?o=get_item(pl.x+t,pl.y):2===pl.d?o=get_item(pl.x,pl.y+t):3===pl.d&&(o=get_item(pl.x-t,pl.y)),o?(o.t===c&&"0"===p?e=!1:l.push(o),c=o.t):e=!1}t++}return l}function get_chip_nrg(l){let e=get_floor(l.x,l.y);return"0"===e||0!=l.dx||0!=l.dy?"#2222CC":0===l.dx&&0===l.dy&&cpu_nrg[l.t]?cpu_nrg[l.t].includes(e)?"#FFFF88":"#FF0000":"#0000FF"}function draw_floor(l,e,t){ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#111111",fill_tile(l,e,t),ctx.stroke()}function draw_wall(l,e,t){ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#111111",fill_tile(l,e,t);for(let c=1;c<=3;c++)ctx.stroke(),bp(),ctx.moveTo(l,e+8*c*t),lt(l+32*t,e+8*c*t),ctx.stroke();for(let c=0;c<2;c++)bp(),ctx.moveTo(l+11*t,e+16*t*c),lt(l+11*t,e+8*t+16*t*c),ctx.stroke(),bp(),ctx.moveTo(l+22*t,e+8*t+16*t*c),lt(l+22*t,e+16*t+16*t*c),ctx.stroke()}function draw_chip(l,e,t,c,p){switch(ctx.fillStyle="#222222",ctx.strokeStyle="#222222",draw_chip_shape(l,e,t),ctx.fillStyle=p,c){case"3":ctx.fillRect(l+9*t,e+8*t,2*t,16*t),ctx.fillRect(l+21*t,e+8*t,2*t,16*t);case"1":ctx.fillRect(l+15*t,e+8*t,2*t,16*t);break;case"2":ctx.fillRect(l+12*t,e+8*t,2*t,16*t),ctx.fillRect(l+18*t,e+8*t,2*t,16*t);break;case"4":ctx.fillRect(l+9*t,e+8*t,2*t,16*t),bp(),ctx.moveTo(l+13*t,e+8*t),lt(l+17*t,e+24*t),lt(l+19*t,e+24*t),lt(l+23*t,e+8*t),lt(l+21*t,e+8*t),lt(l+18*t,e+22*t),lt(l+15*t,e+8*t),ctx.fill();break;case"5":bp(),ctx.moveTo(l+9*t,e+8*t),lt(l+15*t,e+24*t),lt(l+17*t,e+24*t),lt(l+23*t,e+8*t),lt(l+21*t,e+8*t),lt(l+16*t,e+22*t),lt(l+11*t,e+8*t),ctx.fill();break;case"6":ctx.fillRect(l+21*t,e+8*t,2*t,16*t),bp(),ctx.moveTo(l+9*t,e+8*t),lt(l+13*t,e+24*t),lt(l+15*t,e+24*t),lt(l+19*t,e+8*t),lt(l+17*t,e+8*t),lt(l+14*t,e+22*t),lt(l+11*t,e+8*t),ctx.fill();break;case"7":bp(),ctx.moveTo(l+9*t,e+8*t),lt(l+13*t,e+24*t),lt(l+15*t,e+24*t),lt(l+19*t,e+8*t),lt(l+17*t,e+8*t),lt(l+14*t,e+22*t),lt(l+11*t,e+8*t),ctx.fill(),ctx.fillRect(l+18*t,e+8*t,2*t,16*t),ctx.fillRect(l+22*t,e+8*t,2*t,16*t);break;case"8":bp(),ctx.moveTo(l+7*t,e+8*t),lt(l+11*t,e+24*t),lt(l+13*t,e+24*t),lt(l+17*t,e+8*t),lt(l+15*t,e+8*t),lt(l+12*t,e+22*t),lt(l+9*t,e+8*t),ctx.fill(),ctx.fillRect(l+16*t,e+8*t,2*t,16*t),ctx.fillRect(l+19*t,e+8*t,2*t,16*t),ctx.fillRect(l+22*t,e+8*t,2*t,16*t);break;case"9":ctx.fillRect(l+9*t,e+8*t,2*t,16*t),bp(),ctx.moveTo(l+13*t,e+8*t),lt(l+21*t,e+24*t),lt(l+23*t,e+24*t),lt(l+15*t,e+8*t),ctx.fill(),bp(),ctx.moveTo(l+13*t,e+24*t),lt(l+21*t,e+8*t),lt(l+23*t,e+8*t),lt(l+15*t,e+24*t),ctx.fill();break;case"X":bp(),ctx.moveTo(l+9*t,e+8*t),lt(l+19*t,e+24*t),lt(l+23*t,e+24*t),lt(l+13*t,e+8*t),ctx.fill(),bp(),ctx.moveTo(l+9*t,e+24*t),lt(l+19*t,e+8*t),lt(l+23*t,e+8*t),lt(l+13*t,e+24*t),ctx.fill();break}}function draw_socket(l,e,t,c){ctx.fillStyle="#444444",ctx.strokeStyle="#111111",bp(),fill_tile(l,e,t),ctx.stroke(),ctx.fillStyle="#FFFFFF",draw_chip_shape(l,e,t),ctx.fillStyle="#AAAAAA",["A","C","E","G","I"].includes(c)&&(bp(),ctx.arc(l+16*t,e+16*t,3*t,0,2*Math.PI),ctx.fill()),["B","C","D","E","F","G","H","I"].includes(c)&&(bp(),ctx.arc(l+10*t,e+10*t,3*t,0,2*Math.PI),ctx.fill()),["B","C","D","E","F","G","H","I"].includes(c)&&(bp(),ctx.arc(l+22*t,e+22*t,3*t,0,2*Math.PI),ctx.fill()),["D","E","F","G","H","I"].includes(c)&&(bp(),ctx.arc(l+10*t,e+22*t,3*t,0,2*Math.PI),ctx.fill()),["D","E","F","G","H","I"].includes(c)&&(bp(),ctx.arc(l+22*t,e+10*t,3*t,0,2*Math.PI),ctx.fill()),["F","G","H","I"].includes(c)&&(bp(),ctx.arc(l+10*t,e+16*t,3*t,0,2*Math.PI),ctx.fill()),["F","G","H","I"].includes(c)&&(bp(),ctx.arc(l+22*t,e+16*t,3*t,0,2*Math.PI),ctx.fill()),["H","I"].includes(c)&&(bp(),ctx.arc(l+16*t,e+10*t,3*t,0,2*Math.PI),ctx.fill()),["H","I"].includes(c)&&(bp(),ctx.arc(l+16*t,e+22*t,3*t,0,2*Math.PI),ctx.fill()),"J"===c&&(bp(),ctx.moveTo(l+9*t,e+8*t),lt(l+19*t,e+24*t),lt(l+23*t,e+24*t),lt(l+13*t,e+8*t),ctx.fill(),bp(),ctx.moveTo(l+9*t,e+24*t),lt(l+19*t,e+8*t),lt(l+23*t,e+8*t),lt(l+13*t,e+24*t),ctx.fill())}function fill_tile(l,e,t){t||(t=1),bp(),ctx.moveTo(l,e),lt(l+32*t,e),lt(l+32*t,e+32*t),lt(l,e+32*t),lt(l,e),ctx.fill()}function draw_chip_shape(l,e,t){t||(t=1),bp(),ctx.moveTo(l+5*t,e+5*t),lt(l+27*t,e+5*t),lt(l+27*t,e+27*t),lt(l+5*t,e+27*t),ctx.fill();for(let c=0;c<7;c++)bp(),ctx.moveTo(l+6*t+3*c*t,e+30*t),lt(l+6*t+3*c*t,e+2*t),lt(l+7*t+3*c*t,e+2*t),lt(l+7*t+3*c*t,e+30*t),ctx.fill(),bp(),ctx.moveTo(l+30*t,e+6*t+3*c*t),lt(l+2*t,e+6*t+3*c*t),lt(l+2*t,e+7*t+3*c*t),lt(l+30*t,e+7*t+3*c*t),ctx.fill()}function draw_player_idle(l,e,t,c){t||(t=1);let p=l+16*t,o=e+16*t;if(0==c||2==c)ctx.fillStyle="#FFFFFF",bp(),ctx.moveTo(p-9*t,o-2*t),qc(p-14*t,o,p-14*t,o+8*t),qc(p-12*t,o+10*t,p-10*t,o+8*t),lt(p-10*t,o+4*t),lt(p-9*t,o+7*t),lt(p+9*t,o+7*t),lt(p+10*t,o+4*t),lt(p+10*t,o+8*t),qc(p+12*t,o+10*t,p+14*t,o+8*t),qc(p+14*t,o,p+9*t,o-2*t),ctx.stroke(),ctx.fill(),bp(),ctx.moveTo(p-9*t,o-2*t),qc(p-14*t,o-8*t,p-7*t,o-14*t),qc(p,o-16*t,p+7*t,o-14*t),qc(p+14*t,o-8*t,p+9*t,o-2*t),qc(p,o,p-9*t,o-2*t),ctx.stroke(),2==c?(ctx.fill(),ctx.fillStyle="#000000"):(ctx.fillStyle="#000000",ctx.fill()),bp(),ctx.moveTo(p-9*t,o+7*t),lt(p-7*t,o+14*t),qc(p-5*t,o+16*t,p-3*t,o+14*t),lt(p,o+10*t),lt(p+3*t,o+14*t),qc(p+5*t,o+16*t,p+7*t,o+14*t),lt(p+9*t,o+7*t),lt(p-9*t,o+7*t),ctx.stroke(),ctx.fill(),2==c&&(bp(),ctx.moveTo(p-7*t,o-14*t),qc(p,o-16*t,p+7*t,o-14*t),qc(p,o-11*t,p-7*t,o-14*t),ctx.fill(),bp(),ctx.arc(p-6*t,o-8*t,2*t,0,2*Math.PI),ctx.fill(),bp(),ctx.arc(p+6*t,o-8*t,2*t,0,2*Math.PI),ctx.fill());else{let l=1==c?1:-1;ctx.fillStyle="#FFFFFF",bp(),ctx.moveTo(p-7*t,o-2*t),lt(p-5*t,o+7*t),lt(p+5*t,o+7*t),lt(p+7*t,o-2*t),ctx.stroke(),ctx.fill(),bp(),ctx.moveTo(p-7*t,o-2*t),qc(p-10*t,o-8*t,p-7*t,o-14*t),qc(p,o-16*t,p+7*t,o-14*t),qc(p+10*t,o-8*t,p+7*t,o-2*t),qc(p,o,p-7*t,o-2*t),ctx.stroke(),ctx.fill(),ctx.fillStyle="#000000",bp(),ctx.moveTo(p-7*t*l,o-2*t),qc(p-10*t*l,o-8*t,p-7*t*l,o-14*t),qc(p,o-16*t,p+7*t*l,o-14*t),qc(p+1*t*l,o-10*t,p-5*t*l,o-12*t),qc(p-5*t*l,o-5*t,p-7*t*l,o-2*t),ctx.stroke(),ctx.fill(),bp(),ctx.arc(p+4*t*l,o-8*t,2*t,0,2*Math.PI),ctx.fill(),bp(),ctx.moveTo(p-5*t,o+7*t),lt(p-2*t,o+14*t),qc(p,o+16*t,p+2*t,o+14*t),lt(p+5*t,o+7*t),ctx.stroke(),ctx.fill(),ctx.fillStyle="#FFFFFF",bp(),ctx.moveTo(p-2*t,o+4*t),lt(p-2*t,o+8*t),qc(p,o+10*t,p+2*t,o+8*t),lt(p+2*t,o+4*t),ctx.stroke(),ctx.fill()}}function bp(){ctx.beginPath()}function lt(l,e){ctx.lineTo(l,e)}function qc(l,e,t,c){ctx.quadraticCurveTo(l,e,t,c)}window.addEventListener("load",page_load,!1);